var U=Object.create;var v=Object.defineProperty;var $=Object.getOwnPropertyDescriptor;var z=Object.getOwnPropertyNames;var A=Object.getPrototypeOf,R=Object.prototype.hasOwnProperty;var W=(s,t)=>{for(var e in t)v(s,e,{get:t[e],enumerable:!0})},x=(s,t,e,i)=>{if(t&&typeof t=="object"||typeof t=="function")for(let n of z(t))!R.call(s,n)&&n!==e&&v(s,n,{get:()=>t[n],enumerable:!(i=$(t,n))||i.enumerable});return s};var C=(s,t,e)=>(e=s!=null?U(A(s)):{},x(t||!s||!s.__esModule?v(e,"default",{value:s,enumerable:!0}):e,s)),q=s=>x(v({},"__esModule",{value:!0}),s);var L={};W(L,{Cell:()=>f,Chord:()=>p,Converter:()=>_,LogLevel:()=>d,Playlist:()=>g,Song:()=>u,Version:()=>b,convert:()=>G,convertSync:()=>N});module.exports=q(L);var j=C(require("promise"),1);var w=C(require("fast-diff"),1),g=class{constructor(t){let e=/.*?(irealb(?:ook)?):\/\/([^"]*)/.exec(t),n=decodeURIComponent(e[2]).split("===");n.length>1&&(this.name=n.pop()),this.songs=n.map(r=>{try{return new u(r,e[1]==="irealbook")}catch(h){let a=r.split("="),o=u.parseTitle(a[0].trim());return console.error(`[ireal-musicxml] [${o}] ${h}`),null}}).filter(r=>r!==null).reduce((r,h)=>{if(r.length>0){let a=(0,w.default)(r[r.length-1].title,h.title);if(a[0][0]===0&&a.every(o=>o[0]===0||o[1].match(/^\d+$/)))return r[r.length-1].cells=r[r.length-1].cells.concat(h.cells),r}return r.push(h),r},[])}},f=class{constructor(){this.annots=[],this.comments=[],this.bars="",this.spacer=0,this.chord=null}},p=class{constructor(t,e="",i=null,n=null){this.note=t,this.modifiers=e,this.over=i,this.alternate=n}},u=class s{constructor(t,e=!1){if(this.cells=[],this.musicXml="",!t){this.title="",this.composer="",this.style="",this.key="",this.transpose=0,this.groove="",this.bpm=0,this.repeats=0;return}let i=t.split("=");if(e)this.title=s.parseTitle(i[0].trim()),this.composer=s.parseComposer(i[1].trim()),this.style=i[2].trim(),this.key=i[3],this.cells=this.parse(i[5]);else{this.title=s.parseTitle(i[0].trim()),this.composer=s.parseComposer(i[1].trim()),this.style=i[3].trim(),this.key=i[4],this.transpose=+i[5]||0,this.groove=i[7],this.bpm=+i[8],this.repeats=+i[9]||3;let n=i[6].split("1r34LbKcu7");this.cells=this.parse(M(n[1]))}}static chordRegex=/^([A-G][b#]?)((?:sus|alt|add|[+\-^\dhob#])*)(\*.+?\*)*(\/[A-G][#b]?)?(\(.*?\))?/;static chordRegex2=/^([ Wp])()()(\/[A-G][#b]?)?(\(.*?\))?/;static regExps=[/^\*[a-zA-Z]/,/^T\d\d/,/^N./,/^<.*?>/,s.chordRegex,s.chordRegex2];parse(t){let e=t.trim(),i=[];for(;e;){let a=!1;for(let o=0;o<s.regExps.length;o++){let l=s.regExps[o].exec(e);if(l){a=!0,l.length<=2?(i.push(l[0]),e=e.substring(l[0].length)):(i.push(l),e=e.substring(l[0].length));break}}a||(e[0]!==","&&i.push(e[0]),e=e.substring(1))}let n=[],r=this.newCell(n),h=null;for(let a=0;a<i.length;a++){let o=i[a];switch(Array.isArray(o)&&(r.chord=this.parseChord(o),o=" "),o[0]){case"{":case"[":h&&(h.bars+=")",h=null),r.bars=o,o=null;break;case"|":h&&(h.bars+=")",h=null),r.bars="(",o=null;break;case"]":case"}":case"Z":h&&(h.bars+=o,h=null),o=null;break;case"n":r.chord=new p(o[0]);break;case",":o=null;break;case"S":case"T":case"Q":case"N":case"U":case"s":case"l":case"f":case"*":r.annots.push(o),o=null;break;case"Y":r.spacer++,o=null,h=null;break;case"r":case"x":case"W":r.chord=new p(o);break;case"<":o=o.substring(1,o.length-1),r.comments.push(o),o=null;break;default:}o&&a<i.length-1&&(h=r,r=this.newCell(n))}return n}static parseTitle(t){return t.replace(/(.*)(, )(A|The)$/g,"$3 $1")}static parseComposer(t){let e=t.split(/(\s+)/);return e.length===3?e[2]+e[1]+e[0]:t}parseChord(t){let e=t[1]||" ",i=t[2]||"",n=t[3]||"";n&&(i+=n.substring(1,n.length-1));let r=t[4]||"";r[0]==="/"&&(r=r.substring(1));let h=t[5]||null;if(h&&(t=s.chordRegex.exec(h.substring(1,h.length-1)),h=t?this.parseChord(t):null),e===" "&&!h&&!r)return null;if(r){let a=r[1]==="#"||r[1]==="b"?2:1;r=new p(r.substring(0,a),r.substring(a),null,null)}else r=null;return new p(e,i,r,h)}newCell(t){let e=new f;return t.push(e),e}};function M(s){let t="",e;for(;s.length>51;)e=s.substring(0,50),s=s.substring(50),t=t+O(e);return t=t+s,t=t.replace(/Kcl/g,"| x").replace(/LZ/g," |").replace(/XyQ/g,"   "),t}function O(s){let t=s.split("");for(let e=0;e<5;e++)t[49-e]=s[e],t[e]=s[49-e];for(let e=10;e<24;e++)t[49-e]=s[e],t[e]=s[49-e];return t.join("")}var D=C(require("jstoxml"),1),E=C(require("chord-symbol"),1);var y={name:"ireal-musicxml",version:"2.0.4",description:"iReal Pro to MusicXML converter.",author:"Karim Ratib <karim.ratib@gmail.com> (https://github.com/infojunkie)",license:"GPL-3.0-only",repository:{type:"git",url:"https://github.com/infojunkie/ireal-musicxml"},homepage:"https://github.com/infojunkie/ireal-musicxml",type:"module",types:"./build/ireal-musicxml.d.ts",files:["LICENSE.txt","build/*","src/*"],bin:{"ireal-musicxml":"./src/cli/cli.js"},exports:{import:"./build/ireal-musicxml.js",require:"./build/ireal-musicxml.cjs"},scripts:{build:"npm run build:esm && npm run build:cjs && npm run build:d.ts","build:d.ts":"cp src/types/* build/","build:esm":"esbuild src/lib/index.js --bundle --format=esm --minify --sourcemap --outfile=build/ireal-musicxml.js","build:cjs":"esbuild src/lib/index.js --bundle --platform=node --packages=external --minify --sourcemap --outfile=build/ireal-musicxml.cjs",test:"npm run build && npm run test:lint && npm run test:spec && npm run test:ts","test:spec":'node --test --test-name-pattern="${TEST:-.*}"',"test:ts":"node --test --loader=ts-node/esm --require ts-node/register test/*.spec.ts","test:lint":"eslint src --fix"},devDependencies:{"@types/node":"^22.7.7","@xmldom/xmldom":"^0.8.0",esbuild:"0.24.0",eslint:"^9.13.0",resolve:"^1.22.8","sanitize-filename":"^1.6.3","ts-node":"^10.9.2",typescript:"^4.9.5","validate-with-xmllint":"^1.2.0","xpath.js":"^1.1.0"},dependencies:{"chord-symbol":"^3.0.0","fast-diff":"^1.2.0",jstoxml:"^2.0.6",promise:"^8.1.0"}};var b=class{static name=y.name;static version=y.version;static author=y.author;static description=y.description};var{chordParserFactory:I,chordRendererFactory:B}=E.default,d=class{static Debug=0;static Info=1;static Warn=2;static Error=3;static None=4},T="4.0",k=7,S=40,_=class s{static defaultOptions={divisions:768,notation:"rhythmic",step:"B",octave:4,notehead:"slash",noteheadSize:"large",date:!0,clef:!1,keySignature:!1,pageWidth:210,pageHeight:297,pageMargin:15,logLevel:d.Warn};static sequenceAttributes=["divisions","key","time","staves","part-symbol","instruments","clef","staff-details","transpose","directive","measure-style"];static sequenceNote=["cue","pitch","rest","unpitched","duration","tie","voice","type","dot","accidental","time-modification","stem","notehead","notehead-text","staff","beam","notations","lyric","play"];static sequenceNotations=["accidental-mark","arpeggiate","articulations","dynamics","fermata","glissando","non-arpeggiate","ornaments","other-notation","slide","slur","technical","tied","tuplet"];static sequenceBarline=["bar-style","footnote","level","wavy-line","segno","coda","fermata","ending","repeat"];static mapAlter={"#":1,b:-1};static mapFifthsToAlters={sharp:["F","C","G","D","A","E","B"],flat:["B","E","A","D","G","C","F"]};static mapRepeats={"D.C. al Coda":s.prototype.convertDaCapo,"D.C. al Fine":s.prototype.convertDaCapo,"D.C. al 1st End.":s.prototype.convertDaCapo,"D.C. al 2nd End.":s.prototype.convertDaCapo,"D.C. al 3rd End.":s.prototype.convertDaCapo,"D.S. al Coda":s.prototype.convertDalSegno,"D.S. al Fine":s.prototype.convertDalSegno,"D.S. al 1st End.":s.prototype.convertDalSegno,"D.S. al 2nd End.":s.prototype.convertDalSegno,"D.S. al 3rd End.":s.prototype.convertDalSegno,Fine:s.prototype.convertFine,"3x":s.prototype.convertRepeatNx,"4x":s.prototype.convertRepeatNx,"5x":s.prototype.convertRepeatNx,"6x":s.prototype.convertRepeatNx,"7x":s.prototype.convertRepeatNx,"8x":s.prototype.convertRepeatNx};static mapTime={24:{beats:2,beatType:4,beatUnit:1},34:{beats:3,beatType:4,beatUnit:.5},44:{beats:4,beatType:4,beatUnit:1},54:{beats:5,beatType:4,beatUnit:1},64:{beats:6,beatType:4,beatUnit:1},74:{beats:7,beatType:4,beatUnit:1},38:{beats:3,beatType:8,beatUnit:1},58:{beats:5,beatType:8,beatUnit:1},68:{beats:6,beatType:8,beatUnit:1},78:{beats:7,beatType:8,beatUnit:1},98:{beats:9,beatType:8,beatUnit:1},12:{beats:12,beatType:8,beatUnit:3},22:{beats:2,beatType:2,beatUnit:1},32:{beats:3,beatType:2,beatUnit:.5}};static convert(t,e={}){let i=Object.assign({},this.defaultOptions,e);return new s(t,i).convert()}constructor(t,e){this.song=t,this.options=e,this.time={beats:4,beatType:4,beatUnit:1},this.fifths=null,this.measure=null,this.barRepeat=0,this.codas=[],this.repeats=0,this.shortChord=!1,this.emptyCells=0,this.emptyCellNewSystem=!1,this.cellWidth=(this.options.pageWidth-2*this.options.pageMargin)/16,this.parseChord=I({altIntervals:["b5","b9"]}),this.renderChord=B({useShortNamings:!0,printer:"raw"})}convert(){return D.default.toXML(this.convertSong(),{header:`
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE score-partwise PUBLIC "-//Recordare//DTD MusicXML ${T} Partwise//EN" "http://www.musicxml.org/dtds/partwise.dtd">
      `.trim(),indent:"  "})}convertSong(){return{_name:"score-partwise",_attrs:{version:T},_content:[{work:{"work-title":this.song.title}},{identification:[{_name:"creator",_attrs:{type:"composer"},_content:this.song.composer},{encoding:[{software:`@infojunkie/ireal-musicxml ${b.version}`},{...this.options.date&&{"encoding-date":s.convertDate(new Date)}},{_name:"supports",_attrs:{element:"accidental",type:"no"}},{_name:"supports",_attrs:{element:"transpose",type:"no"}},{_name:"supports",_attrs:{attribute:"new-page",element:"print",type:"yes",value:"yes"}},{_name:"supports",_attrs:{attribute:"new-system",element:"print",type:"yes",value:"yes"}}]}]},{defaults:{scaling:{millimeters:k,tenths:S},"page-layout":{"page-height":s._mmToTenths(this.options.pageHeight),"page-width":s._mmToTenths(this.options.pageWidth),"page-margins":{"left-margin":s._mmToTenths(this.options.pageMargin,4),"right-margin":s._mmToTenths(this.options.pageMargin,4),"top-margin":s._mmToTenths(this.options.pageMargin,4),"bottom-margin":s._mmToTenths(this.options.pageMargin,4)}}}},{"part-list":{_name:"score-part",_attrs:{id:"P1"},_content:{_name:"part-name",_attrs:{"print-object":"no"},_content:"Lead Sheet"}}},{_name:"part",_attrs:{id:"P1"},_content:this.convertMeasures()}]}}static convertDate(t){return new Date(t.getTime()-t.getTimezoneOffset()*6e4).toISOString().split("T")[0]}static Measure=class{constructor(t){this.body={_name:"measure",_attrs:{number:t},_content:[]},this.attributes=[],this.chords=[],this.barlines=[],this.barEnding=null}number(){return this.body._attrs.number}assemble(){return this.attributes.length&&this.body._content.push({attributes:s.reorderSequence(this,this.attributes,s.sequenceAttributes)}),this.chords.forEach(t=>{this.body._content.push({harmony:t.harmony},...t.notes.map(e=>({note:e})))}),this.barlines[0]._content=s.reorderSequence(this,this.barlines[0]._content,s.sequenceBarline),this.body._content.splice(1,0,this.barlines[0]),this.barlines[1]._content=s.reorderSequence(this,this.barlines[1]._content,s.sequenceBarline),this.body._content.push(this.barlines[1]),this.body}};static Chord=class{constructor(t,e,i){this.harmony=t,this.notes=e,this.ireal=i,this.spaces=0,this.fermata=!1,this.short=!1}clone(){let t=new s.Chord(structuredClone(this.harmony),structuredClone(this.notes),structuredClone(this.ireal));return t.spaces=this.spaces,t.fermata=this.fermata,t.short=this.short,t}beats(){return this.short?1:1+this.spaces}};convertMeasures(){let t=n=>n>0&&n%16===0,e=this.song.cells.reduce((n,r,h)=>{if((r.bars.match(/\(|\{|\[/)||!this.measure&&(r.chord||r.annots.length||r.comments.length))&&(this.measure&&(this._log(d.Warn,"Starting a new measure over existing measure. Closing current measure first."),this.measure.barlines.push(this.convertBarline("","right")),this.adjustChordsDuration(this.measure)&&n.push(this.measure)),this.measure=new s.Measure(n.length+1,this.options),n.length||(this.measure.attributes.push({divisions:this.options.divisions},{_name:"clef",_attrs:[{"print-object":this.options.clef?"yes":"no"}],_content:[{sign:"G"},{line:2}]},{"staff-details":{"staff-lines":0}},{"measure-style":[{_name:"slash",_attrs:{type:"start","use-stems":this.options.notation==="rhythmic"?"yes":"no"}}]},this.convertKey()),this.song.bpm&&this.measure.body._content.push(this.convertTempo(this.song.bpm)),this.measure.body._content.push(this.convertStyleAndGroove(this.song.style,this.song.groove))),this.measure.barlines.push(this.convertBarline(r.bars,"left",t(h)||this.emptyCellNewSystem?"regular":void 0)),this.barRepeat&&(this.measure.chords=n[n.length-this.barRepeat-1].chords.map(a=>a.clone()))),!this.measure)return(r.chord||r.annots.length||r.comments.length||r.bars&&r.bars!==")")&&this._log(d.Warn,`Found non-empty orphan cell ${JSON.stringify(r)}`,n[n.length-1]),this.emptyCells++,t(h)&&(this.emptyCellNewSystem=!0),n;if((t(h)||this.emptyCellNewSystem)&&this.measure.body._content.splice(0,0,{_name:"print",_attrs:{"new-system":"yes"},_content:{...this.emptyCellNewSystem&&{"system-layout":{"system-margins":[{"left-margin":s._mmToTenths(this.cellWidth*this.emptyCells)},{"right-margin":"0.00"}]}}}}),!this.emptyCellNewSystem&&this.emptyCells>0&&(this.measure.body._content[0]?._name==="print"&&this.measure.body._content[0]._attrs?.["new-system"]==="yes"?n[n.length-1].body._content.splice(0,0,{_name:"print",_content:{"system-layout":{"system-margins":[{"left-margin":"0.00"},{"right-margin":s._mmToTenths(this.cellWidth*this.emptyCells)}]}}}):this.measure.body._content.splice(0,0,{_name:"print",_content:{"measure-layout":{"measure-distance":s._mmToTenths(this.cellWidth*this.emptyCells)}}})),this.emptyCellNewSystem=!1,this.emptyCells=0,r.chord)switch(r.chord.note){case"x":{this.barRepeat=1,this.measure.chords=n[n.length-this.barRepeat].chords.map(a=>a.clone());break}case"r":{this.barRepeat=2,this.measure.chords=n[n.length-this.barRepeat].chords.map(a=>a.clone());break}case"p":if(this.measure.chords.length){this.measure.chords[this.measure.chords.length-1].spaces++;break}case"W":{let a=this.measure;if(a.chords.length||(a=n.slice().reverse().find(o=>o.chords.length),a||this._log(d.Error,`Cannot find any measure with chords prior to ${JSON.stringify(r.chord)}`)),a){let o=a.chords[a.chords.length-1].ireal;o.over=r.chord.over,o.alternate=r.chord.alternate,this.measure.chords.push(this.convertChord(o))}break}case" ":{this._log(d.Warn,`Unhandled empty/alternate chord ${JSON.stringify(r.chord)}`);break}default:this.measure.chords.push(this.convertChord(r.chord)),this.measure.chords[this.measure.chords.length-1].short=this.shortChord}else this.barRepeat||this.measure.chords.length&&this.measure.chords[this.measure.chords.length-1].spaces++;return r.annots.forEach(a=>{switch(a[0]){case"*":{let o=a.slice(1);this.measure.body._content.push(this.convertSection(o));break}case"T":{let o=a.slice(1);this.measure.attributes.push(this.convertTime(o));break}case"S":{this.measure.body._content.push(this.convertSegno());break}case"N":{let o=parseInt(a.slice(1));if(o<1&&(o=n.slice().reverse().find(c=>!!c.barEnding)?.barEnding??1),this.measure.barlines[0]._content.push(this.convertEnding(o,"start")),o>1){n[n.length-1].barlines[1]._content.push(this.convertEnding(o-1,"stop"));let l=n.slice().reverse().find(c=>c.barEnding===o-1);if(!l)this._log(d.Error,`Cannot find ending ${o-1} in right barline of any measure`);else{let c=l.barlines[1]._content.findIndex(m=>!!m&&m._name==="ending");c===-1&&this._log(d.Error,`Cannot find ending ${o-1} in right barline`,l),delete l.barlines[1]._content[c]}}this.measure.barEnding=o;break}case"Q":{this.measure.body._content.push(this.convertToCoda()),this.codas.push(this.measure);break}case"l":{this.measure.chords.length&&(this.measure.chords[this.measure.chords.length-1].short=!1),this.shortChord=!1;break}case"s":{this.measure.chords.length&&(this.measure.chords[this.measure.chords.length-1].short=!0),this.shortChord=!0;break}case"f":{this.measure.chords[this.measure.chords.length-1].fermata=!0;break}case"U":{this.measure.body._content.push(this.convertFine("END"));break}default:this._log(d.Warn,`Unhandled annotation "${a}"`)}}),r.comments.map(a=>a.trim()).forEach(a=>{let o=this._map(s.mapRepeats,a);o?this.measure.body._content.push(o.call(this,a)):this.measure.body._content.push(this.convertComment(a))}),r.bars.match(/\)|\}|\]|Z/)&&this.measure.chords.length&&(this.measure.barlines.push(this.convertBarline(r.bars,"right")),this.measure.barEnding&&this.measure.barlines[1]._content.push(this.convertEnding(this.measure.barEnding,"discontinue")),this.adjustChordsDuration(this.measure)&&n.push(this.measure),this.measure=null,this.barRepeat&&this.barRepeat--),n},[]),i=this.song.cells.length%16-this.emptyCells;if(i>0&&e.length>0&&e[e.length-1].body._content.splice(0,0,{_name:"print",_content:{"system-layout":{"system-margins":[{"left-margin":"0.00"},{"right-margin":s._mmToTenths(this.cellWidth*i)}]}}}),this.codas.length){let n=this.codas[this.codas.length-1],r=n.body._content.findIndex(h=>h._name==="direction"&&Array.isArray(h._content)&&h._content.some(a=>a._name==="sound"&&Object.keys(a._attrs).includes("tocoda")));r===-1&&this._log(d.Warn,"Cannot find sound direction",n),n.body._content[r]=this.convertCoda()}return e.map(n=>n.assemble())}static reorderSequence(t,e,i){return e.filter(n=>Object.keys(n).length).sort((n,r)=>{let h=Object.keys(n)[0];h==="_name"&&(h=n[h]);let a=Object.keys(r)[0];a==="_name"&&(a=r[a]);let o=i.indexOf(h),l=i.indexOf(a);return o===-1&&this._log(d.Warn,`Unrecognized element "${h}"`,t),l===-1&&this._log(d.Warn,`Unrecognized element "${a}"`,t),o-l})}convertRepeatNx(t){let e=null;(e=t.match(/(\d+)x/))!==null&&(this.repeats=e[1])}convertFine(t){return{_name:"direction",_attrs:{placement:"below"},_content:[{"direction-type":{words:t}},{_name:"sound",_attrs:{fine:"yes"}}]}}convertDaCapo(t){return{_name:"direction",_attrs:{placement:"below"},_content:[{"direction-type":{words:t}},{_name:"sound",_attrs:{dacapo:"yes"}}]}}convertDalSegno(t){return{_name:"direction",_attrs:{placement:"below"},_content:[{"direction-type":{words:t}},{_name:"sound",_attrs:{dalsegno:"yes"}}]}}convertComment(t){return{_name:"direction",_attrs:{placement:t[0]==="*"?"above":"below"},_content:{"direction-type":{words:t[0]==="*"?t.slice(3):t}}}}convertEnding(t,e){return{_name:"ending",_attrs:{number:t,type:e},_content:`${t}.`}}convertBarline(t,e,i=void 0){let n=e==="left"?"none":"regular",r=null;return t.match(/\[|\]/)?n="light-light":t.match(/Z/)?n="light-heavy":t.match(/\{|\}/)&&(n=e==="left"?"heavy-light":"light-heavy",r=e==="left"?"forward":"backward"),r==="forward"&&(this.repeats=2),{_name:"barline",_attrs:{location:e},_content:[{"bar-style":i??n},{...r&&{_name:"repeat",_attrs:{direction:r,...r==="backward"&&{times:this.repeats}}}}]}}convertSection(t){return t==="i"&&(t="Intro"),{_name:"direction",_attrs:{placement:"above"},_content:{"direction-type":{rehearsal:t}}}}convertSegno(){return{_name:"direction",_attrs:{placement:"above"},_content:[{"direction-type":{_name:"segno"}},{_name:"sound",_attrs:{segno:"segno"}}]}}convertCoda(){return{_name:"direction",_attrs:{placement:"above"},_content:[{"direction-type":{_name:"coda"}},{_name:"sound",_attrs:{coda:"coda"}}]}}convertToCoda(){return{_name:"direction",_attrs:{placement:"above"},_content:[{"direction-type":{words:"To Coda"}},{_name:"sound",_attrs:{tocoda:"coda"}}]}}convertTempo(t){return{_name:"direction",_attrs:{placement:"above"},_content:[{"direction-type":[{_name:"metronome",_attrs:{parentheses:"no"},_content:[{"beat-unit":this.calculateChordDuration(1)[0].type},{"per-minute":t}]}]},{_name:"sound",_attrs:{tempo:t}}]}}convertTime(t){return this.time=this._map(s.mapTime,t,{beats:parseInt(t[0]),beatType:parseInt(t[1]),beatUnit:1},`Unexpected time signature ${t}`),{time:[{beats:this.time.beats},{"beat-type":this.time.beatType}]}}adjustChordsDuration(t){if(t.chords.length>this.time.beats)return this._log(d.Error,`Too many chords (${t.chords.length} out of ${this.time.beats})`,t),!0;let e=t.chords.reduce((i,n)=>i+n.beats()*this.time.beatUnit,0);if(!e)return this._log(d.Warn,"No chord found. Skipping current measure.",t),!1;if(e>this.time.beats){let i=0;for(;e>this.time.beats;)t.chords[i].spaces>0&&(t.chords[i].spaces--,e-=this.time.beatUnit),i=(i+1)%t.chords.length}else{let i=0,n=!1;for(;e<this.time.beats;)if(t.chords[i].short||(t.chords[i].spaces++,e+=this.time.beatUnit,n=!0),i=(i+1)%t.chords.length,i===0&&!n){this._log(d.Warn,"Cannot add more beats to the current measure.",t);break}}return t.chords=t.chords.map(i=>(i.notes=this.calculateChordDuration(i.beats()*this.time.beatUnit).map((n,r,h)=>this.convertChordNote(n,r===h.length-1?i.fermata:!1,this.options.notation==="rhythmic"&&h.length>1?r>0?"stop":"start":null)),i)),!0}calculateChordDuration(t){let e={1:[{t:"eighth",d:0,b:1}],2:[{t:"quarter",d:0,b:2}],3:[{t:"quarter",d:1,b:3}],4:[{t:"half",d:0,b:4}],5:[{t:"quarter",d:1,b:3},{t:"quarter",d:0,b:2}],6:[{t:"half",d:1,b:6}],7:[{t:"half",d:2,b:7}],8:[{t:"whole",d:0,b:8}],9:[{t:"half",d:1,b:6},{t:"quarter",d:1,b:3}],10:[{t:"half",d:1,b:6},{t:"half",d:0,b:4}],11:[{t:"half",d:2,b:7},{t:"half",d:0,b:4}],12:[{t:"whole",d:1,b:12}],13:[{t:"half",d:2,b:7},{t:"half",d:1,b:6}],14:[{t:"whole",d:2,b:14}],15:[{t:"whole",d:0,b:8},{t:"half",d:2,b:7}]};if(this.options.notation==="slash"){let i=8/this.time.beatType;return Array(t).fill(this._map(e,i,[],`Unexpected beat count 1 for time signature ${this.time.beats}/${this.time.beatType}`).map(n=>({duration:n.b*this.options.divisions/2,type:n.t,dots:n.d}))[0])}else{let i=t*8/this.time.beatType;return this._map(e,i,[],`Unexpected beat count ${t} for time signature ${this.time.beats}/${this.time.beatType}`).map(n=>({duration:n.b*this.options.divisions/2,type:n.t,dots:n.d}))}}convertChordNote(t,e=!1,i=null){let n=s.mapFifthsToAlters[this.fifths>=0?"sharp":"flat"].slice(0,Math.abs(this.fifths)),r={_name:"pitch",_content:[{step:this.options.step},{alter:n.includes(this.options.step)?this.fifths>0?1:-1:0},{octave:this.options.octave}]},h=[];return e&&h.push({_name:"fermata"}),i&&h.push({_name:"tied",_attrs:{type:i}}),s.reorderSequence(this.measure,[r,{_name:"cue"},{_name:"notehead",_content:this.options.notehead,_attrs:[{"font-size":this.options.noteheadSize}]},{duration:t.duration},{voice:1},{_name:"type",_attrs:{size:"full"},_content:t.type},{...h.length&&{notations:s.reorderSequence(this.measure,h,s.sequenceNotations)}}].concat(Array(t.dots).fill({_name:"dot"})),s.sequenceNote)}convertChordDegree(t,e,i){return{_name:"degree",_attrs:{"print-object":"no"},_content:[{"degree-value":t},{"degree-alter":i},{"degree-type":e}]}}convertChordSymbol(t){let e=this.renderChord(this.parseChord(`${t.note}${t.modifiers}`));if(!e)return this._log(d.Warn,`Unrecognized chord "${t.note}${t.modifiers}"`),{rootStep:null,rootAlter:null,chordKind:null,chordDegrees:[],chordText:null};let i=e.input.rootNote[0],n=this._map(s.mapAlter,e.input.rootNote[1]||null,null,`Unrecognized accidental in chord "${e.input.rootNote}"`),r=e.formatted.descriptor+e.formatted.chordChanges.join(""),h={major:"major",major6:"major-sixth",major7:"major-seventh",dominant7:"dominant",minor:"minor",minor6:"minor-sixth",minor7:"minor-seventh",minorMajor7:"major-minor",augmented:"augmented",diminished:"diminished",diminished7:"diminished-seventh",power:"power"},a=this._map(h,e.normalized.quality,"",`Unrecognized chord quality "${e.normalized.quality}"`);if(e.normalized.extensions.length){let l=Math.max(...e.normalized.extensions.map(m=>parseInt(m))).toString(),c={9:"-ninth",11:"-11th",13:"-13th"};a=a.split("-")[0]+this._map(c,l,"",`Unhandled extension ${l}`),a==="dominant-11th"&&(e.normalized.isSuspended=!1)}[{intervals:["1","4","5"],kind:"suspended-fourth",strict:!0},{intervals:["1","5","9"],kind:"suspended-second",strict:!0},{intervals:["1","b3","b5","b7"],kind:"half-diminished",strict:!0},{intervals:["1","3","#5","b7"],kind:"augmented-seventh",strict:!1}].some(l=>{if((!l.strict||e.normalized.intervals.length===l.intervals.length)&&l.intervals.every((c,m)=>c===e.normalized.intervals[m]))return a=l.kind,l.intervals.forEach(c=>{e.normalized.alterations=e.normalized.alterations.filter(m=>m===c),e.normalized.adds=e.normalized.adds.filter(m=>m===c),e.normalized.omits=e.normalized.omits.filter(m=>m===c)}),e.normalized.intervals.forEach(c=>{l.intervals.includes(c)||e.normalized.adds.push(c)}),!0});let o=[];return e.normalized.isSuspended&&!a.includes("suspended")&&(e.normalized.adds.push("4"),e.normalized.adds.includes("3")||e.normalized.omits.push("3")),e.normalized.alterations.forEach(l=>{let c=l.slice(1);o.push(this.convertChordDegree(c,c==="5"||e.normalized.extensions.includes(c)?"alter":"add",this._map(s.mapAlter,l[0],0,`Unrecognized alter symbol in "${l}"`)))}),e.normalized.adds.forEach(l=>{let c=Object.keys(s.mapAlter).includes(l[0])?l[0]:null,m=c?l.slice(1):l;o.push(this.convertChordDegree(m,"add",this._map(s.mapAlter,c,0,`Unrecognized alter symbol in "${l}"`)))}),e.normalized.omits.forEach(l=>{let c=Object.keys(s.mapAlter).includes(l[0])?l[0]:null,m=c?l.slice(1):l;o.push(this.convertChordDegree(m,"subtract",this._map(s.mapAlter,c,0,`Unrecognized alter symbol in "${l}"`)))}),{rootStep:i,rootAlter:n,chordKind:a,chordDegrees:o,chordText:r}}convertChord(t){let e=null;if(t.note==="n")e=[{root:[{_name:"root-step",_attrs:{text:""},_content:this.options.step}]},{_name:"kind",_attrs:{text:"N.C."},_content:"none"}];else{let{rootStep:i,rootAlter:n,chordKind:r,chordDegrees:h,chordText:a}=this.convertChordSymbol(t),o=t.over?[{"bass-step":t.over.note[0]},{...t.over.note[1]&&{"bass-alter":this._map(s.mapAlter,t.over.note[1],null,`Unrecognized accidental in bass note "${t.over.note}"`)}}]:null;e=[{root:[{"root-step":i},{...n&&{"root-alter":n}}]},{_name:"kind",_attrs:{text:a,"use-symbols":"no"},_content:r},{...o&&{bass:o}}].concat(h)}return t.alternate&&this._log(d.Warn,`Unhandled alternate chord ${JSON.stringify(t.alternate)}`),new s.Chord(e,this.calculateChordDuration(1).map(i=>this.convertChordNote(i)),t)}convertKey(){let t={C:0,G:1,D:2,A:3,E:4,B:5,"F#":6,"C#":7,F:-1,Bb:-2,Eb:-3,Ab:-4,Db:-5,Gb:-6,Cb:-7,"A-":0,"E-":1,"B-":2,"F#-":3,"C#-":4,"G#-":5,"D#-":6,"A#-":7,"D-":-1,"G-":-2,"C-":-3,"F-":-4,"Bb-":-5,"Eb-":-6,"Ab-":-7};return this.fifths=this._map(t,this.song.key,0,`Unrecognized key signature "${this.song.key}"`),{_name:"key",_attrs:[{"print-object":this.options.keySignature?"yes":"no"}],_content:[{fifths:this.fifths},{mode:this.song.key.slice(-1)==="-"?"minor":"major"}]}}convertStyleAndGroove(t,e){return{_name:"direction",_attrs:{placement:"above"},_content:[{"direction-type":[{words:t}]},{sound:[{play:[{_name:"other-play",_attrs:{type:"groove"},_content:e||t}]}]}]}}_log(t,e,i=this.measure){if(t<this.options.logLevel)return;let n=`[ireal-musicxml] [${this.song.title}${i?"#"+i.number():""}] ${e}`,r="warn";switch(t){case d.Debug:r="debug";break;case d.Info:r="info";break;case d.Warn:r="warn";break;case d.Error:r="error";break}console[r](n)}_map(t,e,i,n,r=d.Warn,h=this.measure){return e?e in t?t[e]:(n&&this._log(r,n,h),i||null):i}static _mmToTenths(t,e=2){let i=t*S/k,n=Math.pow(10,e);return Math.round(i*n)/n}};function N(s,t={}){let e=new g(s);return e.songs.forEach(i=>{i.musicXml=_.convert(i,t)}),e}async function G(s,t={}){return new j.default(e=>e(N(s,t)))}0&&(module.exports={Cell,Chord,Converter,LogLevel,Playlist,Song,Version,convert,convertSync});
//# sourceMappingURL=ireal-musicxml.cjs.map
