var N=Object.create;var C=Object.defineProperty;var R=Object.getOwnPropertyDescriptor;var W=Object.getOwnPropertyNames;var q=Object.getPrototypeOf,M=Object.prototype.hasOwnProperty;var O=(s,t)=>{for(var e in t)C(s,e,{get:t[e],enumerable:!0})},k=(s,t,e,n)=>{if(t&&typeof t=="object"||typeof t=="function")for(let o of W(t))!M.call(s,o)&&o!==e&&C(s,o,{get:()=>t[o],enumerable:!(n=R(t,o))||n.enumerable});return s};var T=(s,t,e)=>(e=s!=null?N(q(s)):{},k(t||!s||!s.__esModule?C(e,"default",{value:s,enumerable:!0}):e,s)),F=s=>k(C({},"__esModule",{value:!0}),s);var X={};O(X,{Cell:()=>_,Chord:()=>p,Converter:()=>x,LogLevel:()=>m,Playlist:()=>y,Song:()=>b,Version:()=>g,convert:()=>P,convertSync:()=>A});module.exports=F(X);var z=T(require("promise"),1);var S=T(require("fast-diff"),1),y=class{constructor(t){let e=/.*?(irealb(?:ook)?):\/\/([^"]*)/.exec(t),o=decodeURIComponent(e[2]).split("===");o.length>1&&(this.name=o.pop()),this.songs=o.map(r=>{try{return new b(r,e[1]==="irealbook")}catch(l){let a=r.split("="),i=b.parseTitle(a[0].trim());return console.error(`[ireal-musicxml] [${i}] ${l}`),null}}).filter(r=>r!==null).reduce((r,l)=>{if(r.length>0){let a=(0,S.default)(r[r.length-1].title,l.title);if(a[0][0]===0&&a.every(i=>i[0]===0||i[1].match(/^\d+$/)))return r[r.length-1].cells=r[r.length-1].cells.concat(l.cells),r}return r.push(l),r},[])}},_=class{constructor(){this.annots=[],this.comments=[],this.bars="",this.spacer=0,this.chord=null}},p=class{constructor(t,e="",n=null,o=null){this.note=t,this.modifiers=e,this.over=n,this.alternate=o}},b=class s{constructor(t,e=!1){if(this.cells=[],this.musicXml="",!t){this.title="",this.composer="",this.style="",this.key="",this.transpose=0,this.groove="",this.bpm=0,this.repeats=0;return}let n=t.split("=");if(e)this.title=s.parseTitle(n[0].trim()),this.composer=s.parseComposer(n[1].trim()),this.style=n[2].trim(),this.key=n[3],this.cells=this.parse(n[5]);else{this.title=s.parseTitle(n[0].trim()),this.composer=s.parseComposer(n[1].trim()),this.style=n[3].trim(),this.key=n[4],this.transpose=+n[5]||0,this.groove=n[7],this.bpm=+n[8],this.repeats=+n[9]||3;let o=n[6].split("1r34LbKcu7");this.cells=this.parse(I(o[1]))}}static chordRegex=/^([A-G][b#]?)((?:sus|alt|add|[+\-^\dhob#])*)(\*.+?\*)*(\/[A-G][#b]?)?(\(.*?\))?/;static chordRegex2=/^([ Wp])()()(\/[A-G][#b]?)?(\(.*?\))?/;static regExps=[/^\*[a-zA-Z]/,/^T\d\d/,/^N./,/^<.*?>/,s.chordRegex,s.chordRegex2];parse(t){let e=t.trim(),n=[];for(;e;){let a=!1;for(let i=0;i<s.regExps.length;i++){let c=s.regExps[i].exec(e);if(c){a=!0,c.length<=2?(n.push(c[0]),e=e.substring(c[0].length)):(n.push(c),e=e.substring(c[0].length));break}}a||(e[0]!==","&&n.push(e[0]),e=e.substring(1))}let o=[],r=this.newCell(o),l=null;for(let a=0;a<n.length;a++){let i=n[a];switch(Array.isArray(i)&&(r.chord=this.parseChord(i),i=" "),i[0]){case"{":case"[":l&&(l.bars+=")",l=null),r.bars=i,i=null;break;case"|":l&&(l.bars+=")",l=null),r.bars="(",i=null;break;case"]":case"}":case"Z":l&&(l.bars+=i,l=null),i=null;break;case"n":r.chord=new p(i[0]);break;case",":i=null;break;case"S":case"T":case"Q":case"N":case"U":case"s":case"l":case"f":case"*":r.annots.push(i),i=null;break;case"Y":r.spacer++,i=null,l=null;break;case"r":case"x":case"W":r.chord=new p(i);break;case"<":i=i.substring(1,i.length-1),r.comments.push(i),i=null;break;default:}i&&a<n.length-1&&(l=r,r=this.newCell(o))}return o}static parseTitle(t){return t.replace(/(.*)(, )(A|The)$/g,"$3 $1")}static parseComposer(t){let e=t.split(/(\s+)/);return e.length===3?e[2]+e[1]+e[0]:t}parseChord(t){let e=t[1]||" ",n=t[2]||"",o=t[3]||"";o&&(n+=o.substring(1,o.length-1));let r=t[4]||"";r[0]==="/"&&(r=r.substring(1));let l=t[5]||null;if(l&&(t=s.chordRegex.exec(l.substring(1,l.length-1)),l=t?this.parseChord(t):null),e===" "&&!l&&!r)return null;if(r){let a=r[1]==="#"||r[1]==="b"?2:1;r=new p(r.substring(0,a),r.substring(a),null,null)}else r=null;return new p(e,n,r,l)}newCell(t){let e=new _;return t.push(e),e}};function I(s){let t="",e;for(;s.length>51;)e=s.substring(0,50),s=s.substring(50),t=t+B(e);return t=t+s,t=t.replace(/Kcl/g,"| x").replace(/LZ/g," |").replace(/XyQ/g,"   "),t}function B(s){let t=s.split("");for(let e=0;e<5;e++)t[49-e]=s[e],t[e]=s[49-e];for(let e=10;e<24;e++)t[49-e]=s[e],t[e]=s[49-e];return t.join("")}var U=T(require("jstoxml"),1),$=T(require("chord-symbol"),1);var v={name:"@music-i18n/ireal-musicxml",version:"2.1.0",description:"iReal Pro to MusicXML converter.",author:"Karim Ratib <karim.ratib@gmail.com> (https://github.com/infojunkie)",license:"GPL-3.0-only",repository:{type:"git",url:"https://github.com/infojunkie/ireal-musicxml"},homepage:"https://github.com/infojunkie/ireal-musicxml",type:"module",types:"./build/ireal-musicxml.d.ts",files:["LICENSE.txt","build/*","src/*"],bin:{"ireal-musicxml":"./src/cli/cli.js"},exports:{import:"./build/ireal-musicxml.mjs",require:"./build/ireal-musicxml.cjs"},scripts:{build:"npm run build:esm && npm run build:cjs && npm run build:d.ts","build:d.ts":"cp src/types/* build/","build:esm":"esbuild src/lib/index.js --bundle --format=esm --minify --sourcemap --outfile=build/ireal-musicxml.mjs","build:cjs":"esbuild src/lib/index.js --bundle --platform=node --packages=external --minify --sourcemap --outfile=build/ireal-musicxml.cjs",test:"npm run build && npm run test:lint && npm run test:spec && npm run test:ts","test:spec":'node --test --test-name-pattern="${TEST:-.*}"',"test:ts":"node --test --loader=ts-node/esm --require ts-node/register test/*.spec.ts","test:lint":"eslint src --fix"},devDependencies:{"@types/node":"^22.7.7","@xmldom/xmldom":"^0.8.0",esbuild:"0.24.0",eslint:"^9.13.0",resolve:"^1.22.8","sanitize-filename":"^1.6.3","ts-node":"^10.9.2",typescript:"^4.9.5","validate-with-xmllint":"^1.2.0","xpath.js":"^1.1.0"},dependencies:{"chord-symbol":"^3.0.0","fast-diff":"^1.2.0",jstoxml:"^2.0.6",promise:"^8.1.0"}};var g=class{static name=v.name;static version=v.version;static author=v.author;static description=v.description};var{chordParserFactory:L,chordRendererFactory:K}=$.default,m=class{static Debug=0;static Info=1;static Warn=2;static Error=3;static None=4},D="4.0",E=7,j=40,x=class s{static defaultOptions={divisions:768,notation:"rhythmic",step:"B",octave:4,notehead:"slash",noteheadSize:"large",date:!0,clef:!1,keySignature:!1,pageWidth:210,pageHeight:297,pageMargin:15,logLevel:m.Warn};static sequenceAttributes=["divisions","key","time","staves","part-symbol","instruments","clef","staff-details","transpose","directive","measure-style"];static sequenceNote=["cue","pitch","rest","unpitched","duration","tie","voice","type","dot","accidental","time-modification","stem","notehead","notehead-text","staff","beam","notations","lyric","play"];static sequenceNotations=["accidental-mark","arpeggiate","articulations","dynamics","fermata","glissando","non-arpeggiate","ornaments","other-notation","slide","slur","technical","tied","tuplet"];static sequenceBarline=["bar-style","footnote","level","wavy-line","segno","coda","fermata","ending","repeat"];static mapAlter={"#":1,b:-1};static mapFifthsToAlters={sharp:["F","C","G","D","A","E","B"],flat:["B","E","A","D","G","C","F"]};static mapRepeats={"D.C. al Coda":s.prototype.convertDaCapo,"D.C. al Fine":s.prototype.convertDaCapo,"D.C. al 1st End.":s.prototype.convertDaCapo,"D.C. al 2nd End.":s.prototype.convertDaCapo,"D.C. al 3rd End.":s.prototype.convertDaCapo,"D.S. al Coda":s.prototype.convertDalSegno,"D.S. al Fine":s.prototype.convertDalSegno,"D.S. al 1st End.":s.prototype.convertDalSegno,"D.S. al 2nd End.":s.prototype.convertDalSegno,"D.S. al 3rd End.":s.prototype.convertDalSegno,Fine:s.prototype.convertFine,"3x":s.prototype.convertRepeatNx,"4x":s.prototype.convertRepeatNx,"5x":s.prototype.convertRepeatNx,"6x":s.prototype.convertRepeatNx,"7x":s.prototype.convertRepeatNx,"8x":s.prototype.convertRepeatNx};static mapTime={24:{beats:2,beatType:4,beatUnit:1},34:{beats:3,beatType:4,beatUnit:.5},44:{beats:4,beatType:4,beatUnit:1},54:{beats:5,beatType:4,beatUnit:1},64:{beats:6,beatType:4,beatUnit:1},74:{beats:7,beatType:4,beatUnit:1},38:{beats:3,beatType:8,beatUnit:1},58:{beats:5,beatType:8,beatUnit:1},68:{beats:6,beatType:8,beatUnit:1},78:{beats:7,beatType:8,beatUnit:1},98:{beats:9,beatType:8,beatUnit:1},12:{beats:12,beatType:8,beatUnit:3},22:{beats:2,beatType:2,beatUnit:1},32:{beats:3,beatType:2,beatUnit:.5}};static convert(t,e={}){let n=Object.assign({},this.defaultOptions,e);return new s(t,n).convert()}constructor(t,e){this.song=t,this.options=e,this.time={beats:4,beatType:4,beatUnit:1},this.fifths=null,this.measure=null,this.barRepeat=0,this.codas=[],this.repeats=0,this.cellWidth=(this.options.pageWidth-2*this.options.pageMargin)/16,this.parseChord=L({altIntervals:["b5","b9"]}),this.renderChord=K({useShortNamings:!0,printer:"raw"})}convert(){return U.default.toXML(this.convertSong(),{header:`
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE score-partwise PUBLIC "-//Recordare//DTD MusicXML ${D} Partwise//EN" "http://www.musicxml.org/dtds/partwise.dtd">
      `.trim(),indent:"  "})}convertSong(){return{_name:"score-partwise",_attrs:{version:D},_content:[{work:{"work-title":this.song.title}},{identification:[{_name:"creator",_attrs:{type:"composer"},_content:this.song.composer},{encoding:[{software:`@infojunkie/ireal-musicxml ${g.version}`},{...this.options.date&&{"encoding-date":s.convertDate(new Date)}},{_name:"supports",_attrs:{element:"accidental",type:"no"}},{_name:"supports",_attrs:{element:"transpose",type:"no"}},{_name:"supports",_attrs:{attribute:"new-page",element:"print",type:"yes",value:"yes"}},{_name:"supports",_attrs:{attribute:"new-system",element:"print",type:"yes",value:"yes"}}]}]},{defaults:{scaling:{millimeters:E,tenths:j},"page-layout":{"page-height":s._mmToTenths(this.options.pageHeight),"page-width":s._mmToTenths(this.options.pageWidth),"page-margins":{"left-margin":s._mmToTenths(this.options.pageMargin,4),"right-margin":s._mmToTenths(this.options.pageMargin,4),"top-margin":s._mmToTenths(this.options.pageMargin,4),"bottom-margin":s._mmToTenths(this.options.pageMargin,4)}}}},{"part-list":{_name:"score-part",_attrs:{id:"P1"},_content:{_name:"part-name",_attrs:{"print-object":"no"},_content:"Lead Sheet"}}},{_name:"part",_attrs:{id:"P1"},_content:this.convertMeasures()}]}}static convertDate(t){return new Date(t.getTime()-t.getTimezoneOffset()*6e4).toISOString().split("T")[0]}static Measure=class{constructor(t){this.body={_name:"measure",_attrs:{number:t},_content:[]},this.attributes=[],this.chords=[],this.barlines=[],this.barEnding=null}number(){return this.body._attrs.number}assemble(){return this.attributes.length&&this.body._content.push({attributes:s.reorderSequence(this,this.attributes,s.sequenceAttributes)}),this.chords.forEach(t=>{this.body._content.push({harmony:t.harmony},...t.notes.map(e=>({note:e})))}),this.barlines[0]._content=s.reorderSequence(this,this.barlines[0]._content,s.sequenceBarline),this.body._content.splice(1,0,this.barlines[0]),this.barlines[1]._content=s.reorderSequence(this,this.barlines[1]._content,s.sequenceBarline),this.body._content.push(this.barlines[1]),this.body}};static Chord=class{constructor(t,e,n){this.harmony=t,this.notes=e,this.ireal=n,this.spaces=0,this.fermata=!1,this.short=!1}clone(){let t=new s.Chord(structuredClone(this.harmony),structuredClone(this.notes),structuredClone(this.ireal));return t.spaces=this.spaces,t.fermata=this.fermata,t.short=this.short,t}beats(){return this.short?1:1+this.spaces}};convertMeasures(){let t=a=>a>0&&a%16===0,e=0,n=!1,o=!1,r=this.song.cells.reduce((a,i,c)=>{if((i.bars.match(/\(|\{|\[/)||!this.measure&&(i.chord||i.annots.length||i.comments.length))&&(this.measure&&(this._log(m.Warn,"Starting a new measure over existing measure. Closing current measure first."),this.measure.barlines.push(this.convertBarline("","right")),this.adjustChordsDuration(this.measure)&&a.push(this.measure)),this.measure=new s.Measure(a.length+1,this.options),a.length||(this.measure.attributes.push({divisions:this.options.divisions},{_name:"clef",_attrs:[{"print-object":this.options.clef?"yes":"no"}],_content:[{sign:"G"},{line:2}]},{"staff-details":{"staff-lines":0}},{"measure-style":[{_name:"slash",_attrs:{type:"start","use-stems":this.options.notation==="rhythmic"?"yes":"no"}}]},this.convertKey()),this.song.bpm&&this.measure.body._content.push(this.convertTempo(this.song.bpm)),this.measure.body._content.push(this.convertStyleAndGroove(this.song.style,this.song.groove))),this.measure.barlines.push(this.convertBarline(i.bars,"left",t(c)||n?"regular":void 0)),this.barRepeat&&(this.measure.chords=a[a.length-this.barRepeat-1].chords.map(h=>h.clone()))),!this.measure)return(i.chord||i.annots.length||i.comments.length||i.bars&&i.bars!==")")&&this._log(m.Warn,`Found non-empty orphan cell ${JSON.stringify(i)}`,a[a.length-1]),e++,t(c)&&(n=!0),a;if((t(c)||n)&&this.measure.body._content.splice(0,0,{_name:"print",_attrs:{"new-system":"yes"},_content:{...n&&{"system-layout":{"system-margins":[{"left-margin":s._mmToTenths(this.cellWidth*e)},{"right-margin":"0.00"}]}}}}),!n&&e>0&&(this.measure.body._content[0]?._name==="print"&&this.measure.body._content[0]._attrs?.["new-system"]==="yes"?a[a.length-1].body._content.splice(0,0,{_name:"print",_content:{"system-layout":{"system-margins":[{"left-margin":"0.00"},{"right-margin":s._mmToTenths(this.cellWidth*e)}]}}}):this.measure.body._content.splice(0,0,{_name:"print",_content:{"measure-layout":{"measure-distance":s._mmToTenths(this.cellWidth*e)}}})),n=!1,e=0,i.chord)switch(i.chord.note){case"x":{this.barRepeat=1,this.measure.chords=a[a.length-this.barRepeat].chords.map(h=>h.clone());break}case"r":{this.barRepeat=2,this.measure.chords=a[a.length-this.barRepeat].chords.map(h=>h.clone());break}case"p":if(this.measure.chords.length){this.measure.chords[this.measure.chords.length-1].spaces++;break}case"W":{let h=this.measure;if(h.chords.length||(h=a.slice().reverse().find(d=>d.chords.length),h||this._log(m.Error,`Cannot find any measure with chords prior to ${JSON.stringify(i.chord)}`)),h){let d=h.chords[h.chords.length-1].ireal;d.over=i.chord.over,d.alternate=i.chord.alternate,this.measure.chords.push(this.convertChord(d))}break}case" ":{this._log(m.Warn,`Unhandled empty/alternate chord ${JSON.stringify(i.chord)}`);break}default:this.measure.chords.push(this.convertChord(i.chord)),this.measure.chords[this.measure.chords.length-1].short=o}else this.barRepeat||this.measure.chords.length&&this.measure.chords[this.measure.chords.length-1].spaces++;return i.annots.forEach(h=>{switch(h[0]){case"*":{let d=h.slice(1);this.measure.body._content.push(this.convertSection(d));break}case"T":{let d=h.slice(1);this.measure.attributes.push(this.convertTime(d));break}case"S":{this.measure.body._content.push(this.convertSegno());break}case"N":{let d=parseInt(h.slice(1));if(d<1&&(d=a.slice().reverse().find(u=>!!u.barEnding)?.barEnding??1),this.measure.barlines[0]._content.push(this.convertEnding(d,"start")),d>1){a[a.length-1].barlines[1]._content.push(this.convertEnding(d-1,"stop"));let f=a.slice().reverse().find(u=>u.barEnding===d-1);if(!f)this._log(m.Error,`Cannot find ending ${d-1} in right barline of any measure`);else{let u=f.barlines[1]._content.findIndex(w=>!!w&&w._name==="ending");u===-1&&this._log(m.Error,`Cannot find ending ${d-1} in right barline`,f),delete f.barlines[1]._content[u]}}this.measure.barEnding=d;break}case"Q":{this.measure.body._content.push(this.convertToCoda()),this.codas.push(this.measure);break}case"l":{this.measure.chords.length&&(this.measure.chords[this.measure.chords.length-1].short=!1),o=!1;break}case"s":{this.measure.chords.length&&(this.measure.chords[this.measure.chords.length-1].short=!0),o=!0;break}case"f":{this.measure.chords[this.measure.chords.length-1].fermata=!0;break}case"U":{this.measure.body._content.push(this.convertFine("END"));break}default:this._log(m.Warn,`Unhandled annotation "${h}"`)}}),i.comments.map(h=>h.trim()).forEach(h=>{let d=this._map(s.mapRepeats,h);d?this.measure.body._content.push(d.call(this,h)):this.measure.body._content.push(this.convertComment(h))}),i.bars.match(/\)|\}|\]|Z/)&&this.measure.chords.length&&(this.measure.barlines.push(this.convertBarline(i.bars,"right")),this.measure.barEnding&&this.measure.barlines[1]._content.push(this.convertEnding(this.measure.barEnding,"discontinue")),this.adjustChordsDuration(this.measure)&&a.push(this.measure),this.measure=null,this.barRepeat&&this.barRepeat--),a},[]),l=this.song.cells.length%16-e;if(l>0&&r.length>0&&r[r.length-1].body._content.splice(0,0,{_name:"print",_content:{"system-layout":{"system-margins":[{"left-margin":"0.00"},{"right-margin":s._mmToTenths(this.cellWidth*l)}]}}}),this.codas.length){let a=this.codas[this.codas.length-1],i=a.body._content.findIndex(c=>c._name==="direction"&&Array.isArray(c._content)&&c._content.some(h=>h._name==="sound"&&Object.keys(h._attrs).includes("tocoda")));i===-1&&this._log(m.Warn,"Cannot find sound direction",a),a.body._content[i]=this.convertCoda()}return r.map(a=>a.assemble())}static reorderSequence(t,e,n){return e.filter(o=>Object.keys(o).length).sort((o,r)=>{let l=Object.keys(o)[0];l==="_name"&&(l=o[l]);let a=Object.keys(r)[0];a==="_name"&&(a=r[a]);let i=n.indexOf(l),c=n.indexOf(a);return i===-1&&this._log(m.Warn,`Unrecognized element "${l}"`,t),c===-1&&this._log(m.Warn,`Unrecognized element "${a}"`,t),i-c})}convertRepeatNx(t){let e=null;(e=t.match(/(\d+)x/))!==null&&(this.repeats=e[1])}convertFine(t){return{_name:"direction",_attrs:{placement:"below"},_content:[{"direction-type":{words:t}},{_name:"sound",_attrs:{fine:"yes"}}]}}convertDaCapo(t){return{_name:"direction",_attrs:{placement:"below"},_content:[{"direction-type":{words:t}},{_name:"sound",_attrs:{dacapo:"yes"}}]}}convertDalSegno(t){return{_name:"direction",_attrs:{placement:"below"},_content:[{"direction-type":{words:t}},{_name:"sound",_attrs:{dalsegno:"yes"}}]}}convertComment(t){return{_name:"direction",_attrs:{placement:t[0]==="*"?"above":"below"},_content:{"direction-type":{words:t[0]==="*"?t.slice(3):t}}}}convertEnding(t,e){return{_name:"ending",_attrs:{number:t,type:e},_content:`${t}.`}}convertBarline(t,e,n=void 0){let o=e==="left"?"none":"regular",r=null;return t.match(/\[|\]/)?o="light-light":t.match(/Z/)?o="light-heavy":t.match(/\{|\}/)&&(o=e==="left"?"heavy-light":"light-heavy",r=e==="left"?"forward":"backward"),r==="forward"&&(this.repeats=2),{_name:"barline",_attrs:{location:e},_content:[{"bar-style":n??o},{...r&&{_name:"repeat",_attrs:{direction:r,...r==="backward"&&{times:this.repeats}}}}]}}convertSection(t){return t==="i"&&(t="Intro"),{_name:"direction",_attrs:{placement:"above"},_content:{"direction-type":{rehearsal:t}}}}convertSegno(){return{_name:"direction",_attrs:{placement:"above"},_content:[{"direction-type":{_name:"segno"}},{_name:"sound",_attrs:{segno:"segno"}}]}}convertCoda(){return{_name:"direction",_attrs:{placement:"above"},_content:[{"direction-type":{_name:"coda"}},{_name:"sound",_attrs:{coda:"coda"}}]}}convertToCoda(){return{_name:"direction",_attrs:{placement:"above"},_content:[{"direction-type":{words:"To Coda"}},{_name:"sound",_attrs:{tocoda:"coda"}}]}}convertTempo(t){return{_name:"direction",_attrs:{placement:"above"},_content:[{"direction-type":[{_name:"metronome",_attrs:{parentheses:"no"},_content:[{"beat-unit":this.calculateChordDuration(1)[0].type},{"per-minute":t}]}]},{_name:"sound",_attrs:{tempo:t}}]}}convertTime(t){return this.time=this._map(s.mapTime,t,{beats:parseInt(t[0]),beatType:parseInt(t[1]),beatUnit:1},`Unexpected time signature ${t}`),{time:[{beats:this.time.beats},{"beat-type":this.time.beatType}]}}adjustChordsDuration(t){if(t.chords.length>this.time.beats)return this._log(m.Error,`Too many chords (${t.chords.length} out of ${this.time.beats})`,t),!0;let e=t.chords.reduce((n,o)=>n+o.beats()*this.time.beatUnit,0);if(!e)return this._log(m.Warn,"No chord found. Skipping current measure.",t),!1;if(e>this.time.beats){let n=0;for(;e>this.time.beats;)t.chords[n].spaces>0&&(t.chords[n].spaces--,e-=this.time.beatUnit),n=(n+1)%t.chords.length}else{let n=0,o=!1;for(;e<this.time.beats;)if(t.chords[n].short||(t.chords[n].spaces++,e+=this.time.beatUnit,o=!0),n=(n+1)%t.chords.length,n===0&&!o){this._log(m.Warn,"Cannot add more beats to the current measure.",t);break}}return t.chords=t.chords.map(n=>(n.notes=this.calculateChordDuration(n.beats()*this.time.beatUnit).map((o,r,l)=>this.convertChordNote(o,r===l.length-1?n.fermata:!1,this.options.notation==="rhythmic"&&l.length>1?r>0?"stop":"start":null)),n)),!0}calculateChordDuration(t){let e={1:[{t:"eighth",d:0,b:1}],2:[{t:"quarter",d:0,b:2}],3:[{t:"quarter",d:1,b:3}],4:[{t:"half",d:0,b:4}],5:[{t:"quarter",d:1,b:3},{t:"quarter",d:0,b:2}],6:[{t:"half",d:1,b:6}],7:[{t:"half",d:2,b:7}],8:[{t:"whole",d:0,b:8}],9:[{t:"half",d:1,b:6},{t:"quarter",d:1,b:3}],10:[{t:"half",d:1,b:6},{t:"half",d:0,b:4}],11:[{t:"half",d:2,b:7},{t:"half",d:0,b:4}],12:[{t:"whole",d:1,b:12}],13:[{t:"half",d:2,b:7},{t:"half",d:1,b:6}],14:[{t:"whole",d:2,b:14}],15:[{t:"whole",d:0,b:8},{t:"half",d:2,b:7}]};if(this.options.notation==="slash"){let n=8/this.time.beatType;return Array(t).fill(this._map(e,n,[],`Unexpected beat count 1 for time signature ${this.time.beats}/${this.time.beatType}`).map(o=>({duration:o.b*this.options.divisions/2,type:o.t,dots:o.d}))[0])}else{let n=t*8/this.time.beatType;return this._map(e,n,[],`Unexpected beat count ${t} for time signature ${this.time.beats}/${this.time.beatType}`).map(o=>({duration:o.b*this.options.divisions/2,type:o.t,dots:o.d}))}}convertChordNote(t,e=!1,n=null){let o=s.mapFifthsToAlters[this.fifths>=0?"sharp":"flat"].slice(0,Math.abs(this.fifths)),r={_name:"pitch",_content:[{step:this.options.step},{alter:o.includes(this.options.step)?this.fifths>0?1:-1:0},{octave:this.options.octave}]},l=[];return e&&l.push({_name:"fermata"}),n&&l.push({_name:"tied",_attrs:{type:n}}),s.reorderSequence(this.measure,[r,{_name:"cue"},{_name:"notehead",_content:this.options.notehead,_attrs:[{"font-size":this.options.noteheadSize}]},{duration:t.duration},{voice:1},{_name:"type",_attrs:{size:"full"},_content:t.type},{...l.length&&{notations:s.reorderSequence(this.measure,l,s.sequenceNotations)}}].concat(Array(t.dots).fill({_name:"dot"})),s.sequenceNote)}convertChordDegree(t,e,n){return{_name:"degree",_attrs:{"print-object":"no"},_content:[{"degree-value":t},{"degree-alter":n},{"degree-type":e}]}}convertChordSymbol(t){let e=this.renderChord(this.parseChord(`${t.note}${t.modifiers}`));if(!e)return this._log(m.Warn,`Unrecognized chord "${t.note}${t.modifiers}"`),{rootStep:null,rootAlter:null,chordKind:null,chordDegrees:[],chordText:null};let n=e.input.rootNote[0],o=this._map(s.mapAlter,e.input.rootNote[1]||null,null,`Unrecognized accidental in chord "${e.input.rootNote}"`),r=e.formatted.descriptor+e.formatted.chordChanges.join(""),l={major:"major",major6:"major-sixth",major7:"major-seventh",dominant7:"dominant",minor:"minor",minor6:"minor-sixth",minor7:"minor-seventh",minorMajor7:"major-minor",augmented:"augmented",diminished:"diminished",diminished7:"diminished-seventh",power:"power"},a=this._map(l,e.normalized.quality,"",`Unrecognized chord quality "${e.normalized.quality}"`);if(e.normalized.extensions.length){let c=Math.max(...e.normalized.extensions.map(d=>parseInt(d))).toString(),h={9:"-ninth",11:"-11th",13:"-13th"};a=a.split("-")[0]+this._map(h,c,"",`Unhandled extension ${c}`),a==="dominant-11th"&&(e.normalized.isSuspended=!1)}[{intervals:["1","4","5"],kind:"suspended-fourth",strict:!0},{intervals:["1","5","9"],kind:"suspended-second",strict:!0},{intervals:["1","b3","b5","b7"],kind:"half-diminished",strict:!0},{intervals:["1","3","#5","b7"],kind:"augmented-seventh",strict:!1}].some(c=>{if((!c.strict||e.normalized.intervals.length===c.intervals.length)&&c.intervals.every((h,d)=>h===e.normalized.intervals[d]))return a=c.kind,c.intervals.forEach(h=>{e.normalized.alterations=e.normalized.alterations.filter(d=>d===h),e.normalized.adds=e.normalized.adds.filter(d=>d===h),e.normalized.omits=e.normalized.omits.filter(d=>d===h)}),e.normalized.intervals.forEach(h=>{c.intervals.includes(h)||e.normalized.adds.push(h)}),!0});let i=[];return e.normalized.isSuspended&&!a.includes("suspended")&&(e.normalized.adds.push("4"),e.normalized.adds.includes("3")||e.normalized.omits.push("3")),e.normalized.alterations.forEach(c=>{let h=c.slice(1);i.push(this.convertChordDegree(h,h==="5"||e.normalized.extensions.includes(h)?"alter":"add",this._map(s.mapAlter,c[0],0,`Unrecognized alter symbol in "${c}"`)))}),e.normalized.adds.forEach(c=>{let h=Object.keys(s.mapAlter).includes(c[0])?c[0]:null,d=h?c.slice(1):c;i.push(this.convertChordDegree(d,"add",this._map(s.mapAlter,h,0,`Unrecognized alter symbol in "${c}"`)))}),e.normalized.omits.forEach(c=>{let h=Object.keys(s.mapAlter).includes(c[0])?c[0]:null,d=h?c.slice(1):c;i.push(this.convertChordDegree(d,"subtract",this._map(s.mapAlter,h,0,`Unrecognized alter symbol in "${c}"`)))}),{rootStep:n,rootAlter:o,chordKind:a,chordDegrees:i,chordText:r}}convertChord(t){let e=null;if(t.note==="n")e=[{root:[{_name:"root-step",_attrs:{text:""},_content:this.options.step}]},{_name:"kind",_attrs:{text:"N.C."},_content:"none"}];else{let{rootStep:n,rootAlter:o,chordKind:r,chordDegrees:l,chordText:a}=this.convertChordSymbol(t),i=t.over?[{"bass-step":t.over.note[0]},{...t.over.note[1]&&{"bass-alter":this._map(s.mapAlter,t.over.note[1],null,`Unrecognized accidental in bass note "${t.over.note}"`)}}]:null;e=[{root:[{"root-step":n},{...o&&{"root-alter":o}}]},{_name:"kind",_attrs:{text:a,"use-symbols":"no"},_content:r},{...i&&{bass:i}}].concat(l)}return t.alternate&&this._log(m.Warn,`Unhandled alternate chord ${JSON.stringify(t.alternate)}`),new s.Chord(e,this.calculateChordDuration(1).map(n=>this.convertChordNote(n)),t)}convertKey(){let t={C:0,G:1,D:2,A:3,E:4,B:5,"F#":6,"C#":7,F:-1,Bb:-2,Eb:-3,Ab:-4,Db:-5,Gb:-6,Cb:-7,"A-":0,"E-":1,"B-":2,"F#-":3,"C#-":4,"G#-":5,"D#-":6,"A#-":7,"D-":-1,"G-":-2,"C-":-3,"F-":-4,"Bb-":-5,"Eb-":-6,"Ab-":-7};return this.fifths=this._map(t,this.song.key,0,`Unrecognized key signature "${this.song.key}"`),{_name:"key",_attrs:[{"print-object":this.options.keySignature?"yes":"no"}],_content:[{fifths:this.fifths},{mode:this.song.key.slice(-1)==="-"?"minor":"major"}]}}convertStyleAndGroove(t,e){return{_name:"direction",_attrs:{placement:"above"},_content:[{"direction-type":[{words:t}]},{sound:[{play:[{_name:"other-play",_attrs:{type:"groove"},_content:e||t}]}]}]}}_log(t,e,n=this.measure){if(t<this.options.logLevel)return;let o=`[ireal-musicxml] [${this.song.title}${n?"#"+n.number():""}] ${e}`,r="warn";switch(t){case m.Debug:r="debug";break;case m.Info:r="info";break;case m.Warn:r="warn";break;case m.Error:r="error";break}console[r](o)}_map(t,e,n,o,r=m.Warn,l=this.measure){return e?e in t?t[e]:(o&&this._log(r,o,l),n||null):n}static _mmToTenths(t,e=2){let n=t*j/E,o=Math.pow(10,e);return Math.round(n*o)/o}};function A(s,t={}){let e=new y(s);return e.songs.forEach(n=>{n.musicXml=x.convert(n,t)}),e}async function P(s,t={}){return new z.default(e=>e(A(s,t)))}0&&(module.exports={Cell,Chord,Converter,LogLevel,Playlist,Song,Version,convert,convertSync});
//# sourceMappingURL=ireal-musicxml.cjs.map
